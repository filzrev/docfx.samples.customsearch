const pagefind = await import("../pagefind/pagefind.js");

// Define required variables.
globalThis.window = {};
globalThis.document = {};

onmessage = async function(e) {
  if (e.data.q) {
    const query = e.data.q
    pagefind.preload(query);
    const results = pagefind.debouncedSearch(query)
                            .then(async search => {
                              const items = await Promise.all(search.results.map(async (r) => await r.data()))
                              const results = items.map(item => ({
                                href: item.url,
                                title: item.meta.title,
                                keywords: item.excerpt
                              }));
                              postMessage({ e: "query-ready", d: results });
                            });
    
  } else if (e.data.init) {
    await pagefind.options({
      bundlePath: "/pagefind"
    });
    pagefind.init();
    postMessage({ e: "index-ready" });
  }
};

postMessage({ e: "index-ready" });